<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Line Drawing</title>
    <style>body {margin: 0;} video {display:none;}
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
      "use strict";

      function intersect(imP1, imP2, imP3, imP4) {
        var iT = (((imP1[0] - imP3[0])*(imP3[1] - imP4[1])) -
                 ((imP1[1] - imP3[1])*(imP3[0] - imP4[0])))
                 /
                 (((imP1[0] - imP2[0])*(imP3[1] - imP4[1])) -
                 ((imP1[1] - imP2[1])*(imP3[0] - imP4[0])));

        return [Math.round(imP1[0] + iT*(imP2[0] - imP1[0])),
                Math.round(imP1[1] + iT*(imP2[1] - imP1[1]))];

      }

      function frand(fStart, fEnd) {
        return (Math.random() * fEnd) + fStart;
      }

      function rand(iStart, iEnd) {
        return Math.floor((Math.random() * iEnd) + iStart) | 0;
      }

      function chance(iProbability) {
        if (rand(0, 100) >= (100 - iProbability)) {
          return true;
        }

        return false;
      }

      function getNearestYValue(imMap, iX) {
        var iY = 0;

        for (let key of imMap.keys()) {
          iY = imMap.get(key)
          if (iX <= key) {
            return iY;
          }
        }

        return iY;
      }

      function appendMapTail(imDst, imSrc, iX) {
        var imRes = new Map(imDst);

        for (let key of imSrc.keys()) {
          if (key > iX) {
            imRes.set(key, imSrc.get(key));
          }

        }

        return imRes;
      }

      function drawLine(ctx, imPrev, iWidth, cCross) {

        // TODO: Remove debug information.
        console.log("**** DRAW Line ****");
        //console.log(random.binomial(n=10, p=0.5, size=1000));

        // Define the style of the line.
        // TODO: Vary color of line along line??
        var iGrey = rand(0, 100);
        var sRGB = "rgb("+iGrey+","+iGrey+","+iGrey+")";

        ctx.beginPath();
        ctx.strokeStyle = sRGB
        ctx.lineWidth = (iGrey < 20) ? 2 : 1;

        var iYgap = rand(4, 7); // TODO: Maybe write new rand, where numbers closest
                                // to middle are more likely than the fringes?

        var iXpos = 0;
        var iYpos = getNearestYValue(imPrev, 0) + iYgap;
        var imLine = new Map();

        var fXfinish = 1.0;
        if (chance(39)) {
          fXfinish = frand(0.0, 1.0);
          //console.log("LIFT: " + fXfinish + ","  + (iWidth * fXfinish));
        }

        // Move to the start of the line.
        ctx.moveTo(iXpos, iYpos);

        while(iXpos < iWidth) {
          var iYdelta = (iYpos - getNearestYValue(imPrev, iXpos));
          var iYoversize = Math.max(1.0, (iYdelta / (iYgap * 1.7)));

          iXpos = iXpos + rand(2, 5);
          iYpos = iYpos + rand(-2, 5 / iYoversize);

          // Add the next segment to the line.
          ctx.lineTo(iXpos, iYpos);
          imLine.set(iXpos, iYpos);

          // If we touch the line above, our turn is over.
          // var iYprev = getNearestYValue(imPrev, iXpos);
          // if (iYpos - iYprev <= 3) {
          //   console.log("CROSS: " + iXpos, iYpos);
          //   break;
          // }

          // If we lift our pencil, our turn is over. There is 40% chance of
          // accidentially lifting the pencil and finishing the line early.
          if (fXfinish < 1.0 && (iXpos >= iWidth * fXfinish)) {
            break;
          }
        }

        // Render the line and close the path.
        ctx.stroke();
        ctx.closePath();

        // If we didn't make it to the end. Draw a cross.
        if (iXpos < iWidth) {
          drawCross(ctx, cCross, iXpos, iYpos);
          imLine = appendMapTail(imLine, imPrev, iXpos);
        }

        // TODO: Remove debug information.
        // for (let key of imPrev.keys()) {
        //   console.log("imPrev[" + key + "]=" + imPrev.get(key) + "");
        // }

        return imLine;
      }

      function drawCross(ctx, cColor, iXpos, iYpos) {
        var iRandWidth = 5;
        var iRandCurve = 5;
        var iTLx = iXpos - 8;
        var iTLy = iYpos - 8;
        var iBRx = iXpos + 8;
        var iBRy = iYpos + 8;

        var imTL = [iTLx + rand(-iRandWidth, iRandWidth),
                    iTLy + rand(-iRandWidth, iRandWidth)];
        var imBR = [iBRx + rand(-iRandWidth, iRandWidth),
                    iBRy + rand(-iRandWidth, iRandWidth)];
        var imTR = [iBRx + rand(-iRandWidth, iRandWidth),
                    iTLy + rand(-iRandWidth, iRandWidth)];
        var imBL = [iTLx + rand(-iRandWidth, iRandWidth),
                    iBRy + rand(-iRandWidth, iRandWidth)];

        var imIN = intersect(imTL, imBR, imTR, imBL);

        var imOF = [iXpos - imIN[0], iYpos - imIN[1]];
        //console.log("DESIRED POS: [" + iXpos + "," + iYpos + "]");
        //console.log("INTERSECT: [" + imIN[0] + "," + imIN[1] + "]");
        //console.log("OFFSET: [" + imOF[0] + "," + imOF[1] + "]");

        ctx.beginPath();
        ctx.strokeStyle = "rgba(" + 186 + "," + rand(8, 28) + "," + rand(16, 56) + "," + 0.8 + ")";

        //colorToS(cColor); //TODO: Add color variation to cross.
        ctx.lineWidth = 3;

        ctx.moveTo(imTL[0] + imOF[0], imTL[1] + imOF[1]);
        ctx.quadraticCurveTo(iBRx + rand(-iRandCurve, iRandCurve),
                             iBRy + rand(-iRandCurve, iRandCurve),
                             imBR[0] + imOF[0], imBR[1] + imOF[1]);

        ctx.moveTo(imTR[0] + imOF[0], imTR[1] + imOF[1]);
        ctx.quadraticCurveTo(iTLx + rand(-iRandCurve, iRandCurve),
                             iBRy + rand(-iRandCurve, iRandCurve),
                             imBL[0] + imOF[0], imBL[1] + imOF[1]);
        ctx.stroke();
        ctx.closePath();
      }

      (function() {
        var cCross = [186, 8, 16, 0.8];
        var eCanvas = document.getElementById('canvas');
        eCanvas.width = window.innerWidth;
        eCanvas.height = window.innerHeight - 4;

        var ctx = eCanvas.getContext('2d');

        ctx.clearRect(0, 0, cCross, eCanvas.width, eCanvas.height);

        var imStart = new Map([[eCanvas.width, 5]]);

        var imLine = drawLine(ctx, imStart, eCanvas.width, cCross);
        for (var iIdx = 0; iIdx < 70; iIdx = iIdx + 1) {
          imLine = drawLine(ctx, imLine, eCanvas.width, cCross);
        }

        // Tom Sachs studio numbers: (27 / 61) ~ 40% line failure.
      })();

    </script>
  </body>
</html>