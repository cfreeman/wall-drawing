<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Line Drawing</title>
    <style>body {margin: 0;} video {display:none;}
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
      "use strict";

      function intersect(imP1, imP2, imP3, imP4) {
        var iT = (((imP1[0] - imP3[0])*(imP3[1] - imP4[1])) -
                 ((imP1[1] - imP3[1])*(imP3[0] - imP4[0])))
                 /
                 (((imP1[0] - imP2[0])*(imP3[1] - imP4[1])) -
                 ((imP1[1] - imP2[1])*(imP3[0] - imP4[0])));

        return [Math.round(imP1[0] + iT*(imP2[0] - imP1[0])),
                Math.round(imP1[1] + iT*(imP2[1] - imP1[1]))];

      }

      function colorToS(cColor) {
        return "rgb("+cColor[0]+","+cColor[1]+","+cColor[2]+")";
      }

      function rand(iStart, iEnd) {
        return Math.floor((Math.random() * iEnd) + iStart) | 0;
      }


      function chance(iProbability) {
        if (rand(0, 100000) >= (100000 - iProbability)) {
          return true;
        }

        return false;
      }

      function getNearestYValue(imMap, iX) {
        var iY = 0;

        for (let key of imMap.keys()) {
          iY = imMap.get(key)
          if (iX <= key) {
            return iY;
          }
        }

        return iY;
      }

      function appendMapTail(imDst, imSrc, iX) {
        var imRes = new Map(imDst);

        for (let key of imSrc.keys()) {
          if (key > iX) {
            imRes.set(key, imSrc.get(key));
          }

        }

        return imRes;
      }

      function drawLine(ctx, imPrev, iWidth, cLine, cCross) {

        // TODO: Remove debug information.
        console.log("**** DRAW Line ****");
        for (let key of imPrev.keys()) {
          console.log("imPrev[" + key + "]=" + imPrev.get(key) + "");
        }

        // Define the style of the line.
        ctx.beginPath();
        ctx.strokeStyle = colorToS(cLine);  // TODO: vary pressure / colour along line.
        ctx.lineWidth = 1;

        var iYgap = rand(7, 15);
        //console.log("iYdelta: " + iYdelta);

        var iXpos = 0;
        var iYpos = getNearestYValue(imPrev, 0) + iYgap;
        console.log("iYStart: " + iYpos);

        var imLine = new Map();

        // Move to the start of the line.
        ctx.moveTo(iXpos, iYpos);

        while(iXpos < iWidth) {
          var iYdelta = (iYpos - getNearestYValue(imPrev, iXpos));
          var iYoversize = Math.max(1.0, (iYdelta / iYgap));
          // console.log("iYgap="+ iYgap +", iYdelta =" + iYdelta, ", iYoversize=" + iYoversize);

          iXpos = iXpos + rand(2, 5);
          iYpos = iYpos + rand(-2, 5 / iYoversize);

          // Add the next segment to the line.
          ctx.lineTo(iXpos, iYpos);
          imLine.set(iXpos, iYpos);

          // If we touch the line above, our turn is over.
          var iYprev = getNearestYValue(imPrev, iXpos);
          //console.log("getNearestYValue(" + iXpos + ")=" + iYprev);
          //console.log("cross="+ (iYpos - iYprev <= 2));
          if (iYpos - iYprev <= 3) {
            break;
          }

          // If we lift our pencil, our turn is over. There is 0.0001% chance of
          // accidentially lifting the pencil and finishing the line early.
          if(chance(1)) {
            break;
          }
        }

        // Render the line and close the path.
        ctx.stroke();
        ctx.closePath();

        // If we didn't make it to the end. Draw a cross.
        if (iXpos < iWidth) {
          drawCross(ctx, cCross, iXpos, iYpos);
          imLine = appendMapTail(imLine, imPrev, iXpos);
        }

        // TODO: Remove debug information.
        // for (let key of imPrev.keys()) {
        //   console.log("imPrev[" + key + "]=" + imPrev.get(key) + "");
        // }

        return imLine;
      }

      function drawCross(ctx, cColor, iXpos, iYpos) {
        var iRandWidth = 7;
        var iRandCurve = 7;
        var iTLx = iXpos - 10;
        var iTLy = iYpos - 10;
        var iBRx = iXpos + 10;
        var iBRy = iYpos + 10;

        var imTL = [iTLx + rand(-iRandWidth, iRandWidth),
                    iTLy + rand(-iRandWidth, iRandWidth)];
        var imBR = [iBRx + rand(-iRandWidth, iRandWidth),
                    iBRy + rand(-iRandWidth, iRandWidth)];
        var imTR = [iBRx + rand(-iRandWidth, iRandWidth),
                    iTLy + rand(-iRandWidth, iRandWidth)];
        var imBL = [iTLx + rand(-iRandWidth, iRandWidth),
                    iBRy + rand(-iRandWidth, iRandWidth)];

        var imIN = intersect(imTL, imBR, imTR, imBL);

        var imOF = [iXpos - imIN[0], iYpos - imIN[1]];
        console.log("DESIRED POS: [" + iXpos + "," + iYpos + "]");
        console.log("INTERSECT: [" + imIN[0] + "," + imIN[1] + "]");
        console.log("OFFSET: [" + imOF[0] + "," + imOF[1] + "]");

        ctx.beginPath();
        ctx.strokeStyle = colorToS(cColor);
        ctx.lineWidth = 4;

        ctx.moveTo(imTL[0] + imOF[0], imTL[1] + imOF[1]);
        ctx.quadraticCurveTo(iBRx + rand(-iRandCurve, iRandCurve),
                             iBRy + rand(-iRandCurve, iRandCurve),
                             imBR[0] + imOF[0], imBR[1] + imOF[1]);

        ctx.moveTo(imTR[0] + imOF[0], imTR[1] + imOF[1]);
        ctx.quadraticCurveTo(iTLx + rand(-iRandCurve, iRandCurve),
                             iBRy + rand(-iRandCurve, iRandCurve),
                             imBL[0] + imOF[0], imBL[1] + imOF[1]);
        ctx.stroke();
        ctx.closePath();
      }

      (function() {
        var cCross = [186, 8, 16];
        var cLine = [0, 0, 0];
        var eCanvas = document.getElementById('canvas');
        eCanvas.width = window.innerWidth;
        eCanvas.height = window.innerHeight - 4;

        var ctx = eCanvas.getContext('2d');

        ctx.clearRect(0, 0, cCross, eCanvas.width, eCanvas.height);

        var imStart = new Map([[eCanvas.width, 5]]);

        var imLine = drawLine(ctx, imStart, eCanvas.width, cLine, cCross);
        imLine = drawLine(ctx, imLine, eCanvas.width, cLine, cCross);
        imLine = drawLine(ctx, imLine, eCanvas.width, cLine, cCross);
        imLine = drawLine(ctx, imLine, eCanvas.width, cLine, cCross);
        imLine = drawLine(ctx, imLine, eCanvas.width, cLine, cCross);
        imLine = drawLine(ctx, imLine, eCanvas.width, cLine, cCross);

        // 27 / 61 ~ 40% line failure.

        // for(var j = 20; j < 400; j = j+100) {
        //   for(var i = 20; i < 500; i = i+100) {
        //
        //   }
        // }
      })();

    </script>
  </body>
</html>